<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>後台管理</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .order { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    button { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>訂單管理</h1>
  <div id="orders"></div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "你的API_KEY",
      authDomain: "zero-01-17457.firebaseapp.com",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "發送ID",
      appId: "你的APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    const ordersRef = firebase.database().ref("orders");

    // 監聽訂單資料
    ordersRef.on("value", snapshot => {
      const ordersContainer = document.getElementById("orders");
      ordersContainer.innerHTML = "";
      const orders = snapshot.val();
      if (!orders) {
        ordersContainer.textContent = "目前沒有訂單";
        return;
      }

      Object.keys(orders).forEach(orderId => {
        const order = orders[orderId];
        const div = document.createElement("div");
        div.classList.add("order");

        // 計算總金額（防止字串相加錯誤）
        let orderTotal = 0;
        if (order.items) {
          Object.values(order.items).forEach(item => {
            const price = Number(item.price) || 0;
            const qty   = Number(item.quantity) || 0;
            orderTotal += price * qty;
          });
        }

        div.innerHTML = `
          <p><b>桌號：</b>${order.table || "未指定"}</p>
          <p><b>時間：</b>${order.time || "未知"}</p>
          <p><b>狀態：</b>${order.status || "未知"}</p>
          <p><b>總金額：</b>$${orderTotal.toLocaleString()}</p>
          <button class="status-btn" data-id="${orderId}">更新狀態</button>
          <button class="delete-btn" data-id="${orderId}">刪除訂單</button>
        `;

        ordersContainer.appendChild(div);
      });

      // 綁定按鈕事件
      document.querySelectorAll(".status-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const currentStatus = orders[id].status || "new";
          const nextStatus = getNextStatus(currentStatus);
          updateOrderStatus(id, nextStatus);
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          deleteOrder(id);
        });
      });
    });

    // 狀態更新
    function updateOrderStatus(orderId, newStatus) {
      firebase.database().ref(`orders/${orderId}/status`).set(newStatus)
        .then(() => alert(`訂單 ${orderId} 狀態更新為 ${newStatus}`))
        .catch(err => alert("更新失敗：" + err.message));
    }

    // 刪除訂單
    function deleteOrder(orderId) {
      if (confirm(`確定刪除訂單 ${orderId} 嗎？`)) {
        firebase.database().ref(`orders/${orderId}`).remove()
          .then(() => alert(`訂單 ${orderId} 已刪除`))
          .catch(err => alert("刪除失敗：" + err.message));
      }
    }

    // 狀態循環邏輯
    function getNextStatus(current) {
      const flow = ["new", "preparing", "served", "paid"];
      const idx = flow.indexOf(current);
      return flow[(idx + 1) % flow.length];
    }
  </script>
</body>
</html>

