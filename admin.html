<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>後台管理</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .order { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    select, button { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>訂單管理</h1>
  <div id="orders"></div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "你的API_KEY",
      authDomain: "zero-01-17457.firebaseapp.com",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "發送ID",
      appId: "你的APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    const ordersRef = firebase.database().ref("orders");

    // 狀態選項
    const statusOptions = ["new", "preparing", "served", "paid"];

    // 監聽訂單資料
    ordersRef.on("value", snapshot => {
      const ordersContainer = document.getElementById("orders");
      ordersContainer.innerHTML = "";
      const orders = snapshot.val();
      if (!orders) {
        ordersContainer.textContent = "目前沒有訂單";
        return;
      }

      Object.keys(orders).forEach(orderId => {
        const order = orders[orderId];
        const div = document.createElement("div");
        div.classList.add("order");

        // 計算總金額
        let orderTotal = 0;
        if (order.items) {
          Object.values(order.items).forEach(item => {
            const price = parseFloat(item.price) || 0;
            const qty   = parseFloat(item.quantity) || 0;
            orderTotal += price * qty;
          });
        }

        // 狀態下拉選單
        const statusSelect = document.createElement("select");
        statusOptions.forEach(st => {
          const option = document.createElement("option");
          option.value = st;
          option.textContent = st;
          if (order.status === st) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusSelect.addEventListener("change", () => {
          updateOrderStatus(orderId, statusSelect.value);
        });

        // 刪除按鈕
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "刪除訂單";
        deleteBtn.addEventListener("click", () => {
          deleteOrder(orderId);
        });

        div.innerHTML = `
          <p><b>桌號：</b>${order.table || "未指定"}</p>
          <p><b>時間：</b>${order.time || "未知"}</p>
          <p><b>總金額：</b>$${orderTotal.toLocaleString()}</p>
        `;

        div.appendChild(statusSelect);
        div.appendChild(deleteBtn);
        ordersContainer.appendChild(div);
      });
    });

    // 更新訂單狀態
    function updateOrderStatus(orderId, newStatus) {
      firebase.database().ref(`orders/${orderId}/status`).set(newStatus)
        .catch(err => alert("更新失敗：" + err.message));
    }

    // 刪除訂單
    function deleteOrder(orderId) {
      if (confirm(`確定刪除訂單 ${orderId} 嗎？`)) {
        firebase.database().ref(`orders/${orderId}`).remove()
          .catch(err => alert("刪除失敗：" + err.message));
      }
    }
  </script>
</body>
</html>

