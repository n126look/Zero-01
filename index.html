<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é»é¤ç³»çµ±</title>

  <!-- Firebaseï¼ˆcompat ç‰ˆï¼Œæ–¹ä¾¿ä½¿ç”¨å…¨åŸŸ firebase ç‰©ä»¶ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;
           padding: 1rem; background: #f7f7f7; }
    h1, h2 { color: #333; }
    .item { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px;
            padding: 1rem; margin: .5rem 0; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .row { display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .name { font-weight: 600; }
    .price { color: #666; }
    .qty { width: 90px; }
    .note { flex: 1 1 220px; min-width: 220px; }
    .total { margin: 1rem 0 0.5rem; font-size: 1.15rem; font-weight: 800; }
    button {
      margin-top: .75rem; padding: .8rem 1.4rem; font-size: 1.05rem; font-weight: 600;
      background: #0d6efd; color: #fff; border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background:#0b5ed7; }
    .message { margin-top: .75rem; font-weight: 700; min-height: 1.25rem; }
    .ok { color:#0a7d39; } .err { color:#b3261e; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ æ‰‹æ©Ÿé»é¤</h1>
  <div id="menu"></div>

  <!-- âœ… å³æ™‚è¨ˆç®—ç¸½åƒ¹é¡¯ç¤º -->
  <div id="total" class="total">åˆè¨ˆé‡‘é¡ï¼š$0</div>

  <button id="submit">é€å‡ºè¨‚å–®</button>
  <div class="message" id="message"></div>

  <script>
    // å°å·¥å…·
    const byId = (id) => document.getElementById(id);
    const menuDiv = byId("menu");
    const messageDiv = byId("message");
    const totalDiv = byId("total");
    const submitBtn = byId("submit");
    const currentTable = new URLSearchParams(location.search).get("table") || "01";

    const state = {
      source: null,      // 'firebase' | 'json'
      menuData: null     // { itemId: {name, price, category, enable_note}, ... }
    };

    // Firebase è¨­å®šï¼ˆç”¨ä½ çš„å°ˆæ¡ˆè³‡æ–™ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyDaC14zf1ZxOsd-twyjzSgTIcNBwty1Is",
      authDomain: "zero-01-17457.firebaseapp.com",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "534119998616",
      appId: "1:534119998616:web:ec3b6c2d48318f9c51ced",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.warn("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œæ”¹ç”¨ JSON å‚™æ´ï¼š", e);
    }

    // å„ªå…ˆè®€ Firebaseï¼Œå¤±æ•—å‰‡è®€æœ¬åœ° JSON
    async function loadMenu() {
      if (db) {
        try {
          const snap = await db.ref("menu_items").once("value");
          const data = snap.val();
          if (data && Object.keys(data).length) {
            state.source = "firebase";
            state.menuData = data;
            console.info("âœ… èœå–®ä¾†æºï¼šFirebase");
            renderMenu(data);
            updateTotal();
            return;
          }
          console.warn("Firebase /menu_items ç„¡è³‡æ–™ï¼Œæ”¹è®€ JSONã€‚");
        } catch (err) {
          console.warn("è®€å– Firebase å¤±æ•—ï¼Œæ”¹è®€ JSONï¼š", err);
        }
      }
      try {
        const res = await fetch("menu_items.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.source = "json";
        state.menuData = data;
        console.info("âœ… èœå–®ä¾†æºï¼šmenu_items.json");
        renderMenu(data);
        updateTotal();
      } catch (err) {
        messageDiv.className = "message err";
        messageDiv.textContent = `âš ï¸ ç„¡æ³•å–å¾—èœå–®ï¼ˆFirebase èˆ‡ JSON çš†å¤±æ•—ï¼‰ï¼š${err.message}`;
      }
    }

    // æ¸²æŸ“èœå–®
    function renderMenu(rawData) {
      // åˆ†é¡
      const grouped = {};
      Object.entries(rawData).forEach(([id, item]) => {
        const cat = item.category || "å…¶ä»–";
        (grouped[cat] ||= []).push({ ...item, id });
      });

      // æ¸…ç©ºä¸¦ç”Ÿæˆ
      menuDiv.innerHTML = "";
      Object.entries(grouped).forEach(([cat, items]) => {
        const title = document.createElement("h2");
        title.textContent = cat;
        menuDiv.appendChild(title);

        items.forEach(item => {
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = `
            <div class="row">
              <span class="name">${item.name}</span>
              <span class="price">ï¼„${item.price}</span>
              <label>æ•¸é‡ï¼š
                <input class="qty" type="number" min="0" value="0" id="qty-${item.id}">
              </label>
              ${item.enable_note ? `
                <input class="note" type="text" id="note-${item.id}" placeholder="å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰">` : ""}
            </div>
          `;
          menuDiv.appendChild(card);

          // ç¶å®šï¼šæ•¸é‡è®Šå‹•å³æ™‚æ›´æ–°ç¸½åƒ¹
          card.querySelector(`#qty-${item.id}`).addEventListener("input", updateTotal);
        });
      });
    }

    // å³æ™‚è¨ˆç®—ç¸½åƒ¹ï¼ˆç”¨ state.menuDataï¼Œä¸é‡æŠ“è³‡æ–™åº«ï¼‰
    function updateTotal() {
      const data = state.menuData || {};
      let total = 0;
      for (const id of Object.keys(data)) {
        const qtyEl = byId(`qty-${id}`);
        if (!qtyEl) continue;
        const qty = parseInt(qtyEl.value, 10) || 0;
        if (qty > 0) total += (Number(data[id].price) || 0) * qty;
      }
      totalDiv.textContent = `åˆè¨ˆé‡‘é¡ï¼š$${total}`;
    }

    // é€å‡ºè¨‚å–®
    submitBtn.addEventListener("click", async () => {
      messageDiv.textContent = "";
      messageDiv.className = "message";

      const data = state.menuData || {};
      const items = [];

      for (const id of Object.keys(data)) {
        const qtyEl = byId(`qty-${id}`);
        if (!qtyEl) continue;
        const qty = parseInt(qtyEl.value, 10) || 0;
        if (qty > 0) {
          const noteEl = byId(`note-${id}`);
          const note = noteEl ? (noteEl.value || "").trim() : "";
          items.push({ name: data[id].name, price: data[id].price, quantity: qty, note });
        }
      }

      if (items.length === 0) {
        messageDiv.className = "message err";
        messageDiv.textContent = "âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€é …é¤é»";
        return;
      }

      const order = {
        table: currentTable,
        time: new Date().toISOString(),
        items,
        total: Number(totalDiv.textContent.replace(/[^\d]/g, "")) || 0
      };

      if (state.source === "firebase" && db) {
        try {
          await db.ref("orders").push(order);
          messageDiv.className = "message ok";
          messageDiv.textContent = "âœ… è¨‚å–®é€å‡ºæˆåŠŸï¼Œè«‹ç¨å€™ä¸Šèœï¼";
          setTimeout(() => location.reload(), 1500);
        } catch (err) {
          messageDiv.className = "message err";
          messageDiv.textContent = `âš ï¸ è¨‚å–®é€å‡ºå¤±æ•—ï¼š${err.message}`;
        }
      } else {
        console.log("ï¼ˆJSON å‚™æ´ï¼‰ä»¥ä¸‹è¨‚å–®åƒ…æ–¼å‰ç«¯è¨˜éŒ„ï¼š", order);
        messageDiv.className = "message ok";
        messageDiv.textContent = "âœ… å·²è¨˜éŒ„æ‚¨çš„é¸æ“‡ï¼ˆç›®å‰ç‚ºé›¢ç·š/JSON æ¨¡å¼ï¼Œä¸æœƒå¯«å…¥é›²ç«¯ï¼‰";
      }
    });

    // å•Ÿå‹•
    loadMenu();
  </script>
</body>
</html>

