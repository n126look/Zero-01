<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>é»é¤ç³»çµ±</title>

  <!-- Firebaseï¼ˆcompat ç‰ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    /* === åœ–ç‰‡æ ¼ç‹€èœå–® === */
.menu-toolbar{
  display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0 10px;
}
.menu-toolbar .pager{ display:flex; gap:6px; align-items:center; }
.menu-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr); /* æ‰‹æ©Ÿï¼š2 æ¬„ */
  gap:12px;
}
@media (min-width: 640px){ .menu-grid{ grid-template-columns: repeat(3, 1fr); } }
@media (min-width: 920px){ .menu-grid{ grid-template-columns: repeat(4, 1fr); } }

.card2{
  background:#fff; border:1px solid #e5e5e5; border-radius:12px;
  overflow:hidden; display:flex; flex-direction:column;
  box-shadow:0 2px 10px rgba(0,0,0,.04);
}
.card2 .pic{
  aspect-ratio: 4/3;
  background:#f3f4f6;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.card2 .pic img{ width:100%; height:100%; object-fit:cover; }
.card2 .body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
.card2 .name{ font-weight:700; line-height:1.2; min-height:2.4em; }
.card2 .price{ color:#334155; font-weight:800; }
.card2 .ops{ display:flex; align-items:center; gap:8px; }
.card2 .qtybox{
  display:flex; align-items:center; gap:6px; margin-left:auto;
}
.card2 .qtybox button{
  width:32px; height:32px; border-radius:8px; border:1px solid #d0d7de; background:#fff; cursor:pointer;
}
.card2 .qtybox input{
  width:48px; text-align:center; padding:6px; border:1px solid #d0d7de; border-radius:8px;
}
.card2 .note{
  width:100%; padding:7px 8px; border:1px dashed #cbd5e1; border-radius:10px; font-size:.9rem;
}
.btn-lite{ padding:6px 10px; border-radius:10px; border:1px solid #d0d7de; background:#fff; cursor:pointer; }
.btn-lite[disabled]{ opacity:.6; cursor:not-allowed; }

  </style>
</head>
<body>
  <header><h1>ğŸ“‹ æ‰‹æ©Ÿé»é¤</h1></header>

  <main>
    <div id="menu"></div>
    <div id="msg" class="message info"></div>

    <section id="success" class="success">
      <h3>âœ… è¨‚å–®å·²é€å‡º</h3>
      <p>æ‚¨çš„è¨‚å–®ç·¨è™Ÿï¼š</p>
      <p class="code" id="orderId">â€”</p>
      <p style="margin-top:8px;">è«‹ä¿æŒé é¢æˆ–å‡ºç¤ºæ­¤ç•«é¢çµ¦æœå‹™äººå“¡ã€‚</p>
      <!-- å›åˆ°é»é¤ä¸¦ä¿ç•™ç•¶å‰ ?table= -->
      <button class="primary" onclick="location.href = location.pathname + location.search">å›åˆ°é»é¤</button>
    </section>
  </main>

  <div class="checkout-bar" id="checkoutBar">
    <div class="sum" id="total">åˆè¨ˆé‡‘é¡ï¼š$0</div>
    <div class="muted" id="tableInfo"></div>
    <button class="primary" id="submitBtn" disabled>é€å‡ºè¨‚å–®</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= åŸºæœ¬å·¥å…· =========
    const $ = (id) => document.getElementById(id);
    const fmt = new Intl.NumberFormat('zh-TW');
    function showToast(text, ms=1600) {
      const t = $("toast"); t.textContent = text; t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), ms);
    }

    // ========= ç‹€æ…‹ =========
    const qs = new URLSearchParams(location.search);
    const currentTable = qs.get("table") || "01";
    $("tableInfo").textContent = `æ¡Œè™Ÿï¼š${currentTable}`;
    const STORAGE_KEY = `cart_${currentTable}`;
    const state = { source: null, menu: {}, submitting: false };

    // æœ‰æ•ˆ session idï¼ˆé€šéé–‹æ¡Œæª¢æŸ¥å¾Œå–å¾—ï¼‰
    let ACTIVE_SESSION_ID = null;

    // ========= Firebase è¨­å®š =========
    const firebaseConfig = {
      apiKey: "AIzaSyDaC14zf1ZxOsd-twyjzSgTIcNBwty1Is",
      authDomain: "zero-01-17457.firebaseapp.com",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "534119998616",
      appId: "1:534119998616:web:ec3b6c2d48318f9c51ced",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    let db = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); }
    catch(e){ console.warn("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œæ”¹ç”¨ JSON å‚™æ´ï¼š", e); }

    // ========= èœå–®ä¾†æºæ§åˆ¶ =========
    const MENU_VER = "2025-08-11-01";                 // æ¯æ¬¡æ”¹åƒ¹æ›æ–°ç‰ˆæœ¬
    const MENU_URL = `menu_items.json?v=${MENU_VER}`; // é¿å…å¿«å–
    const sourceOverride = qs.get("source");          // ?source=json å¯å¼·åˆ¶ç”¨ JSON

    // ========= é–‹æ¡Œ session æª¢æŸ¥ï¼ˆé‡è¦ï¼‰ =========
    async function checkSession() {
      // JSON æ¨¡å¼æˆ–æœ¬åœ°æ¸¬è©¦æ™‚å¯æ”¾è¡Œï¼ˆæ²’æœ‰ dbï¼‰
      if (!db) return true;

      try {
        const snap = await db.ref(`tables/${currentTable}/session`).once("value");
        const sess = snap.val();
        if (!sess || !sess.id || !sess.expiresAt || Number(sess.expiresAt) <= Date.now()) {
          $("msg").className = "message err";
          $("msg").textContent = "æ­¤æ¡Œå°šæœªé–‹æ¡Œæˆ–å·²çµå¸³ï¼Œè«‹æ´½æœå‹™äººå“¡ã€‚";
          $("submitBtn").disabled = true;
          return false;
        }
        ACTIVE_SESSION_ID = String(sess.id);
        return true;
      } catch (e) {
        $("msg").className = "message err";
        $("msg").textContent = "è®€å–æ¡Œæ³å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦æˆ–æ´½æœå‹™äººå“¡ã€‚";
        $("submitBtn").disabled = true;
        return false;
      }
    }

    // ========= è®€èœå–®ï¼ˆFirebase å„ªå…ˆï¼Œå¤±æ•—/è¦†è“‹å‰‡ç”¨ JSONï¼‰=========
    async function loadMenu() {
      $("msg").className = "message info";
      $("msg").textContent = "æ­£åœ¨è¼‰å…¥èœå–®â€¦";

      if (db && sourceOverride !== "json") {
        try {
          const snap = await db.ref("menu_items").once("value");
          const data = snap.val();
          if (data && Object.keys(data).length) {
            state.source = "firebase";
            state.menu = data;
            renderMenu(data);
            restoreCart();
            updateTotal();
            $("msg").textContent = "";
            return;
          }
        } catch(err){ console.warn("è®€å– Firebase å¤±æ•—ï¼š", err); }
      }

      try {
        const res = await fetch(MENU_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.source = "json";
        state.menu = data;
        renderMenu(data);
        restoreCart();
        updateTotal();
        $("msg").textContent = "ï¼ˆç›®å‰ç‚ºé›¢ç·š/JSON æ¨¡å¼ï¼‰";
      } catch(err){
        $("msg").className = "message err";
        $("msg").textContent = `âš ï¸ ç„¡æ³•å–å¾—èœå–®ï¼š${err.message}`;
      }
    }

    // ========= æ¸²æŸ“èœå–® =========
    function renderMenu(raw){
      const menu = $("menu");
      menu.innerHTML = "";
      const grouped = {};
      Object.entries(raw).forEach(([id, item])=>{
        (grouped[item.category || "å…¶ä»–"] ||= []).push({ ...item, id });
      });

      Object.entries(grouped).forEach(([cat, items])=>{
        const h = document.createElement("h2"); h.textContent = cat; menu.appendChild(h);
        items.forEach(item=>{
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = `
            <div class="row">
              <span class="name">${item.name}</span>
              <span class="price">ï¼„${fmt.format(Number(item.price)||0)}</span>
              <label>æ•¸é‡ï¼š
                <input class="qty" type="number" inputmode="numeric" pattern="[0-9]*"
                       min="0" value="0" id="qty-${item.id}">
              </label>
              ${item.enable_note ? `
                <input class="note" type="text" id="note-${item.id}" placeholder="å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰">` : ""}
            </div>
          `;
          menu.appendChild(card);

          const qtyEl = card.querySelector(`#qty-${item.id}`);
          qtyEl.addEventListener("input", ()=>{ clampQty(qtyEl); updateTotal(); saveCart(); });
          const noteEl = card.querySelector(`#note-${item.id}`);
          if (noteEl) noteEl.addEventListener("change", saveCart);
        });
      });
    }

    function clampQty(el){
      const v = parseInt(el.value || "0", 10);
      if (isNaN(v) || v < 0) el.value = 0;
      // å¯è¦–éœ€æ±‚è¨­ä¸Šé™ï¼šif (v > 99) el.value = 99;
    }

    // ========= æš«å­˜ï¼ˆä¾æ¡Œè™Ÿåˆ†é–‹ï¼‰=========
    function saveCart(){
      const data = {};
      Object.keys(state.menu).forEach(id=>{
        const qEl = $(`qty-${id}`);
        const nEl = $(`note-${id}`);
        if (!qEl) return;
        const qty = parseInt(qEl.value||"0",10)||0;
        const note = nEl ? (nEl.value||"") : "";
        if (qty>0 || note) data[id] = { qty, note };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function restoreCart(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const cart = JSON.parse(raw);
        Object.entries(cart).forEach(([id, {qty, note}])=>{
          const qEl = $(`qty-${id}`); if (qEl) qEl.value = qty;
          const nEl = $(`note-${id}`); if (nEl && note) nEl.value = note;
        });
      }catch{}
    }

    // ========= çµ±ä¸€çš„ç¸½åƒ¹è¨ˆç®— =========
    function calcTotal(){
      let total = 0;
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        if (q>0) total += (Number(state.menu[id].price)||0) * q;
      });
      return total;
    }

    // ========= è¨ˆç®—ç¸½åƒ¹ & æ§åˆ¶é€å‡ºéˆ• =========
    function updateTotal(){
      const total = calcTotal();
      let count = 0;
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        count += q;
      });
      $("total").textContent = `åˆè¨ˆé‡‘é¡ï¼š$${fmt.format(total)}${count?`ï¼ˆ${count} é …ï¼‰`:""}`;
      $("submitBtn").disabled = (count === 0) || state.submitting;
    }

    // ========= é€å‡ºè¨‚å–® =========
    $("submitBtn").addEventListener("click", async ()=>{
      if (state.submitting) return;
      state.submitting = true; updateTotal();

      const items = [];
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        if (q>0){
          const note = $(`note-${id}`)?.value?.trim() || "";
          items.push({
            id, name: state.menu[id].name,
            price: Number(state.menu[id].price)||0, quantity: q, note
          });
        }
      });

      if (items.length === 0){
        showToast("è«‹å…ˆé¸æ“‡é¤é»");
        state.submitting = false; updateTotal(); return;
      }

      const total = calcTotal();

      // å¸¶å…¥ sessionIdï¼Œä¾› Rules é©—è­‰
      const order = {
        table: currentTable,
        sessionId: ACTIVE_SESSION_ID || null, // JSON æ¨¡å¼æ™‚å¯èƒ½ç‚º null
        time: new Date().toISOString(),
        items,
        total
      };

      const btn = $("submitBtn");
      const oldText = btn.textContent;
      btn.textContent = "é€å‡ºä¸­â€¦";
      btn.disabled = true;

      if (state.source === "firebase" && db){
        try{
          const ref = await db.ref("orders").push(order);
          localStorage.removeItem(STORAGE_KEY);
          $("msg").className = "message ok";
          $("msg").textContent = "";
          $("success").style.display = "block";
          $("orderId").textContent = ref.key || "(æœªçŸ¥ç·¨è™Ÿ)";
          $("checkoutBar").style.display = "none";
          $("menu").style.display = "none";
          showToast("è¨‚å–®å·²é€å‡º");
        }catch(err){
          $("msg").className = "message err";
          $("msg").textContent = `âš ï¸ è¨‚å–®é€å‡ºå¤±æ•—ï¼š${err.message}`;
          showToast("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
          state.submitting = false; btn.textContent = oldText; updateTotal();
        }
      } else {
        console.log("ï¼ˆJSON æ¨¡å¼ï¼‰åƒ…å‰ç«¯è¨˜éŒ„ï¼š", order);
        $("msg").className = "message ok";
        $("msg").textContent = "âœ… å·²è¨˜éŒ„æ‚¨çš„é¸æ“‡ï¼ˆç›®å‰ç‚ºé›¢ç·š/JSON æ¨¡å¼ï¼‰";
        showToast("å·²è¨˜éŒ„æ‚¨çš„é¸æ“‡");
        state.submitting = false; btn.textContent = oldText; updateTotal();
      }
    });

    // ========= å•Ÿå‹•ï¼šå…ˆæª¢æŸ¥é–‹æ¡Œï¼Œå†è¼‰èœå–® =========
    (async () => {
      const ok = await checkSession();   // å…ˆåšæ¡Œæ³é©—è­‰
      if (ok) loadMenu();
    })();
  </script>
</body>
</html>
