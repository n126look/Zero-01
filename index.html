<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é»é¤ç³»çµ±</title>

  <!-- ä½¿ç”¨ compat ç‰ˆ SDKï¼Œæ–¹ä¾¿åœ¨ <script> ç›´æ¥ä½¿ç”¨å…¨åŸŸ firebase ç‰©ä»¶ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
           padding: 1rem; background: #f7f7f7; }
    h1, h2 { color: #333; }
    .item { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px;
            padding: 1rem; margin: .5rem 0; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .row { display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .name { font-weight: 600; }
    .price { color: #666; }
    .qty { width: 90px; }
    .note { flex: 1 1 220px; min-width: 220px; }
    button {
      margin-top: 1.25rem; padding: .8rem 1.4rem; font-size: 1.05rem; font-weight: 600;
      background: #0d6efd; color: #fff; border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background:#0b5ed7; }
    .message { margin-top: 1rem; font-weight: 700; }
    .ok { color:#0a7d39; } .err { color:#b3261e; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ æ‰‹æ©Ÿé»é¤</h1>
  <div id="menu"></div>
  <button id="submit">é€å‡ºè¨‚å–®</button>
  <div class="message" id="message"></div>

  <script>
    // === 1) Firebase è¨­å®š ===
    const firebaseConfig = {
      apiKey: "AIzaSyDaC14zf1ZxOsd-twyjzSgTIcNBwty1Is",
      authDomain: "zero-01-17457.firebaseapp.com",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "534119998616",
      appId: "1:534119998616:web:ec3b6c2d48318f9c51ced",
      // âœ… ä½¿ç”¨ä½ è³‡æ–™åº«å¯¦éš›æ‰€åœ¨å€åŸŸï¼ˆSingaporeï¼‰
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === 2) DOM åƒç…§ ===
    const menuDiv = document.getElementById("menu");
    const messageDiv = document.getElementById("message");
    const submitBtn = document.getElementById("submit");
    const currentTable = new URLSearchParams(location.search).get("table") || "01";

    // === 3) è¼‰å…¥èœå–® ===
    const menuRef = db.ref("menu_items");
    menuRef.once("value")
      .then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          menuDiv.innerHTML = "<p>å°šç„¡èœå–®è³‡æ–™ã€‚</p>";
          return;
        }

        // ä¾åˆ†é¡åˆ†çµ„
        const grouped = {};
        Object.entries(data).forEach(([id, item]) => {
          const cat = item.category || "å…¶ä»–";
          (grouped[cat] ||= []).push({ ...item, id });
        });

        // ç”Ÿæˆç•«é¢
        Object.entries(grouped).forEach(([cat, items]) => {
          const title = document.createElement("h2");
          title.textContent = cat;
          menuDiv.appendChild(title);

          items.forEach(item => {
            const card = document.createElement("div");
            card.className = "item";
            card.innerHTML = `
              <div class="row">
                <span class="name">${item.name}</span>
                <span class="price">ï¼„${item.price}</span>
                <label>æ•¸é‡ï¼š
                  <input class="qty" type="number" min="0" value="0" id="qty-${item.id}">
                </label>
                ${item.enable_note ? `
                  <input class="note" type="text" id="note-${item.id}" placeholder="å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰">` : ""}
              </div>
            `;
            menuDiv.appendChild(card);
          });
        });
      })
      .catch(err => {
        messageDiv.className = "message err";
        messageDiv.textContent = `âš ï¸ ç„¡æ³•è¼‰å…¥èœå–®ï¼š${err.message}`;
      });

    // === 4) é€å‡ºè¨‚å–® ===
    submitBtn.addEventListener("click", () => {
      messageDiv.textContent = "";
      messageDiv.className = "message";

      menuRef.once("value")
        .then(snapshot => {
          const data = snapshot.val() || {};
          const items = [];

          for (const id of Object.keys(data)) {
            const qtyEl = document.getElementById(`qty-${id}`);
            if (!qtyEl) continue;
            const qty = parseInt(qtyEl.value, 10) || 0;
            if (qty > 0) {
              const noteEl = document.getElementById(`note-${id}`);
              const note = noteEl ? (noteEl.value || "").trim() : "";
              items.push({ name: data[id].name, quantity: qty, note });
            }
          }

          if (items.length === 0) {
            messageDiv.className = "message err";
            messageDiv.textContent = "âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€é …é¤é»";
            return;
          }

          const order = {
            table: currentTable,
            time: new Date().toISOString(),
            items
          };

          return db.ref("orders").push(order);
        })
        .then(() => {
          if (!messageDiv.textContent) {
            messageDiv.className = "message ok";
            messageDiv.textContent = "âœ… è¨‚å–®é€å‡ºæˆåŠŸï¼Œè«‹ç¨å€™ä¸Šèœï¼";
            setTimeout(() => location.reload(), 1500);
          }
        })
        .catch(err => {
          messageDiv.className = "message err";
          messageDiv.textContent = `âš ï¸ è¨‚å–®é€å‡ºå¤±æ•—ï¼š${err.message}`;
        });
    });
  </script>
</body>
</html>
