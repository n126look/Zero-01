<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>é»é¤ç³»çµ±</title>

  <!-- ç¦æ­¢å¿«å–ï¼Œæ›´æ–°æ¨£å¼æ™‚æ¯”è¼ƒä¸æœƒå¡ä½ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Firebaseï¼ˆcompat ç‰ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    :root{
      color-scheme: light;
      --bg:#f3efe7;            /* ç±³è‰²åº• */
      --card:#fff;             /* å¡ç‰‡ç™½ */
      --ink:#1f2937;           /* æ–‡å­— */
      --muted:#6b7280;
      --brand:#0f1b2d;         /* æ·±è—æ¨™é ­ */
      --accent:#ff7a00;        /* åº•éƒ¨æ©˜è‰²æ¢ */
      --primary:#0d6efd;       /* ä¸»è¦æŒ‰éˆ• */
      --radius:16px;
      --shadow:0 10px 24px rgba(0,0,0,.08);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;
      color:var(--ink);
      background:
        radial-gradient(40rem 40rem at -10% -10%, #ffffff90, transparent 60%),
        radial-gradient(30rem 30rem at 120% -20%, #fce9d480, transparent 55%),
        var(--bg);
    }

    /* å¤–æ¡† Panel */
    .panel{
      max-width: 980px;
      margin: 22px auto 110px;
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      background: var(--card);
      overflow:hidden;
    }
    .panel-head{
      background: var(--brand);
      color:#fff;
      padding: 20px 22px;
      display:flex; align-items:center; gap:14px;
    }
    .panel-head h1{
      margin:0; font-size: clamp(22px, 4.8vw, 34px); letter-spacing:.06em;
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .panel-head small{ display:block; margin-top:6px; font-size:15px; opacity:.9; }

    .panel-body{ padding: 18px; background: #fbfaf7; }

    /* é¡åˆ¥æ¨™é¡Œ */
    h2.cat{
      margin: 14px 6px 10px;
      font-size: clamp(18px, 4.2vw, 22px);
    }

    /* èœå–®åˆ—ï¼šå·¦åœ–å³æ–‡ */
    .menu-row{
      background:var(--card);
      border:1px solid #ece7dd;
      border-radius: var(--radius);
      box-shadow: 0 4px 14px rgba(0,0,0,.05);
      padding:14px;
      display:grid;
      grid-template-columns: 96px 1fr;
      gap:14px;
      align-items:center;
      margin:12px 6px;
    }
    .thumb{
      width:96px; height:96px; border-radius: 12px; overflow:hidden;
      background:#f2f3f5; display:flex; align-items:center; justify-content:center;
      box-shadow: inset 0 0 0 1px #e9edf2;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ display:flex; flex-direction:column; gap:10px; }
    .title{
      display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;
    }
    .name{ font-size: clamp(18px, 4.4vw, 22px); font-weight:900; }
    .price{ font-size: clamp(16px, 4vw, 20px); color:var(--ink); }

    /* åŠ æ¸›æ•¸é‡æ¢ */
    .qtyline{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .qtybox{
      margin-left:auto; display:flex; align-items:center; gap:10px;
    }
    .btn{
      width:44px; height:44px; border-radius:12px;
      border:1px solid #d0d7de; background:#fff;
      display:flex; align-items:center; justify-content:center;
      font-size:24px; line-height:1; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .btn:active{ transform: scale(.98); }
    .qtydisp{ min-width:28px; text-align:center; font-weight:900; font-size:22px; }

    .note{
      width:100%; height:42px;
      padding:10px 12px; border-radius:10px; border:1px solid #e3e3e3;
      background:#fff; color:var(--ink); font-size:16px;
    }

    /* åº•éƒ¨å°è¨ˆæ¢ï¼‹é€å‡º */
    .checkout{
      position:fixed; left:0; right:0; bottom:0;
      background: linear-gradient(#fff, #f7f3ea);
      border-top:1px solid #e9e1d3;
      padding:12px; display:flex; align-items:center; gap:12px;
      z-index:10;
    }
    .sum{ font-size: clamp(18px,4.2vw,22px); font-weight:900; }
    .muted{ color:var(--muted); font-size:15px; margin-left:6px; }
    .primary{
      margin-left:auto; padding:.9rem 1.25rem; font-size:18px; font-weight:900;
      background:#2b5bea; color:#fff; border:0; border-radius:14px; cursor:pointer;
      box-shadow: 0 8px 24px rgba(43,91,234,.35);
    }
    .primary[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    /* åº•éƒ¨æ©˜è‰²è£é£¾æ¢ï¼ˆç´”è¦–è¦ºï¼‰ */
    .accent-bar{
      height:16px; border-radius:12px; background:var(--accent); opacity:.85;
      margin:18px 6px 6px;
    }

    /* æˆåŠŸç•«é¢ */
    .success{ display:none; padding:30px; text-align:center; }
    .success h3{ margin:0 0 8px; font-size:22px; }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#f6f4ed; border:1px dashed #d9ccb6; border-radius:8px;
      display:inline-block; padding:6px 10px;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:84px; transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:10px;
      font-size:.95rem; opacity:0; pointer-events:none; transition:opacity .25s;
      z-index:100;
    }
    .toast.show{ opacity:1; }

    /* æ‰‹æ©Ÿçª„è¢å¹•èª¿æ•´ */
    @media (max-width:640px){
      .menu-row{ grid-template-columns: 84px 1fr; gap:12px; }
      .thumb{ width:84px; height:84px; }
      .btn{ width:40px; height:40px; font-size:22px; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="panel-head">
      <h1>ğŸ—’ï¸ æ‰‹æ©Ÿé»é¤</h1>
    </div>

    <div class="panel-body">
      <div id="tableLine" style="margin:4px 6px 14px; color:#fff0; height:0;"></div>
      <div id="menu"></div>

      <div id="msg" style="padding:10px 6px; font-weight:700;"></div>

      <div class="accent-bar" aria-hidden="true"></div>

      <section id="success" class="success">
        <h3>âœ… è¨‚å–®å·²é€å‡º</h3>
        <p>æ‚¨çš„è¨‚å–®ç·¨è™Ÿï¼š</p>
        <p class="code" id="orderId">â€”</p>
        <p style="margin-top:8px;">è«‹ä¿æŒé é¢æˆ–å‡ºç¤ºæ­¤ç•«é¢çµ¦æœå‹™äººå“¡ã€‚</p>
        <button class="primary" onclick="location.href = location.pathname + location.search">å›åˆ°é»é¤</button>
      </section>
    </div>
  </div>

  <div class="checkout">
    <div class="sum" id="total">åˆè¨ˆé‡‘é¡ï¼š$0</div>
    <div class="muted" id="tableInfo"></div>
    <button class="primary" id="submitBtn" disabled>é€å‡ºè¨‚å–®</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ========= å°å·¥å…· ========= */
    const $ = (id) => document.getElementById(id);
    const fmt = new Intl.NumberFormat('zh-TW');
    function showToast(text, ms=1600){ const t=$("toast"); t.textContent=text; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }

    /* ========= ç‹€æ…‹ ========= */
    const qs = new URLSearchParams(location.search);
    const currentTable = qs.get("table") || "01";
    $("tableInfo").textContent = `æ¡Œè™Ÿï¼š ${currentTable}`;
    const STORAGE_KEY = `cart_${currentTable}`;
    const state = { source:null, menu:{}, submitting:false };
    let ACTIVE_SESSION_ID = null;

    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyDaC14zf1ZxOsd-twyjzSgTIcNBwty1Is",
      authDomain: "zero-01-17457.firebaseapp.com",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "534119998616",
      appId: "1:534119998616:web:ec3b6c2d48318f9c51ced",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    let db=null; try{ firebase.initializeApp(firebaseConfig); db=firebase.database(); }catch(e){ console.warn("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œæ”¹ç”¨ JSON æ¨¡å¼ï¼š", e); }

    function normalizeMenuData(data){
      if (data && typeof data==="object" && data.menu_items && typeof data.menu_items==="object") return data.menu_items;
      return data || {};
    }

    const MENU_VER = "ui-2025-08-13-02";
    const MENU_URL = `menu_items.json?v=${MENU_VER}`;
    const sourceOverride = qs.get("source");

    /* ========= é–‹æ¡Œæª¢æŸ¥ ========= */
    async function checkSession(){
      if (!db) return true;
      try{
        const snap = await db.ref(`tables/${currentTable}/session`).once("value");
        const sess = snap.val();
        if (!sess || !sess.id || !sess.expiresAt || Number(sess.expiresAt) <= Date.now()){
          setMsg("æ­¤æ¡Œå°šæœªé–‹æ¡Œæˆ–å·²çµå¸³ï¼Œè«‹æ´½æœå‹™äººå“¡ã€‚", true);
          $("submitBtn").disabled = true;
          return false;
        }
        ACTIVE_SESSION_ID = String(sess.id);
        return true;
      }catch(e){
        setMsg("è®€å–æ¡Œæ³å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦æˆ–æ´½æœå‹™äººå“¡ã€‚", true);
        $("submitBtn").disabled = true;
        return false;
      }
    }
    function setMsg(text, err=false){ const el=$("msg"); el.textContent=text; el.style.color= err ? "#b3261e" : "#0b5ed7"; }

    /* ========= è®€èœå–® ========= */
    async function loadMenu(){
      setMsg("æ­£åœ¨è¼‰å…¥èœå–®â€¦");
      if (db && sourceOverride!=="json"){
        try{
          const snap = await db.ref("menu_items").once("value");
          const data = normalizeMenuData(snap.val());
          if (data && Object.keys(data).length){
            state.source="firebase"; state.menu=data; renderMenu(data); restoreCart(); updateTotal(); setMsg("");
            return;
          }
        }catch(e){ console.warn("è®€å– Firebase å¤±æ•—ï¼š", e); }
      }
      try{
        const res = await fetch(MENU_URL, { cache:"no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        const data = normalizeMenuData(raw);
        state.source="json"; state.menu=data; renderMenu(data); restoreCart(); updateTotal();
        setMsg("ï¼ˆç›®å‰ç‚ºé›¢ç·š/JSON æ¨¡å¼ï¼‰");
      }catch(e){ setMsg(`âš ï¸ ç„¡æ³•å–å¾—èœå–®ï¼š${e.message}`, true); }
    }

    /* ========= æ•¸é‡å·¥å…· ========= */
    const getQty = id => parseInt( (document.getElementById(`qty-${id}`)?.value)||"0",10 ) || 0;
    function setQty(id, v){
      const val = Math.max(0, Math.min(99, parseInt(v,10)||0));
      const hidden = document.getElementById(`qty-${id}`);
      const disp   = document.getElementById(`qtdis-${id}`);
      if (hidden) hidden.value = val;
      if (disp)   disp.textContent = val;
    }

    /* ========= æ¸²æŸ“ ========= */
    function renderMenu(raw){
      const menu = $("menu");
      menu.innerHTML = "";
      const grouped={};
      Object.entries(raw).forEach(([id,item]) => (grouped[item.category||"å…¶ä»–"] ??= []).push({...item,id}));

      Object.entries(grouped).forEach(([cat, items])=>{
        const h = document.createElement("h2"); h.className="cat"; h.textContent=cat; menu.appendChild(h);

        items.forEach(item=>{
          const row = document.createElement("div");
          row.className="menu-row";
          row.innerHTML = `
            <div class="thumb">
              ${item.img ? `<img src="${item.img}" alt="${item.name||''}" loading="lazy" onerror="this.remove()">` : ""}
            </div>
            <div class="meta">
              <div class="title">
                <div class="name">${item.name||""}</div>
                <div class="price">$ ${fmt.format(Number(item.price)||0)}</div>
              </div>

              <div class="qtyline">
                ${item.enable_note ? `<input class="note" id="note-${item.id}" placeholder="å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰">` : `<span class="muted" style="font-size:14px;"></span>`}

                <div class="qtybox" data-id="${item.id}">
                  <button class="btn minus" type="button" data-id="${item.id}" aria-label="æ¸›">âˆ’</button>
                  <span class="qtydisp" id="qtdis-${item.id}">0</span>
                  <button class="btn plus"  type="button" data-id="${item.id}" aria-label="åŠ ">ï¼‹</button>
                </div>
              </div>
            </div>

            <input type="hidden" id="qty-${item.id}" value="0">
          `;
          menu.appendChild(row);
        });
      });

      // ç¶å®š + / -
      menu.querySelectorAll(".qtybox .plus").forEach(btn=>{
        btn.onclick = ()=>{ const id=btn.dataset.id; setQty(id, getQty(id)+1); updateTotal(); saveCart(); };
      });
      menu.querySelectorAll(".qtybox .minus").forEach(btn=>{
        btn.onclick = ()=>{ const id=btn.dataset.id; setQty(id, Math.max(0, getQty(id)-1)); updateTotal(); saveCart(); };
      });
      // å‚™è¨»å„²å­˜
      menu.querySelectorAll("input.note").forEach(n=> n.addEventListener("change", saveCart));
    }

    /* ========= æš«å­˜ ========= */
    function saveCart(){
      const data={};
      Object.keys(state.menu).forEach(id=>{
        const qty=getQty(id); const note=$(`note-${id}`)?.value||"";
        if (qty>0 || note) data[id]={qty, note};
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function restoreCart(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const cart=JSON.parse(raw);
        Object.entries(cart).forEach(([id,{qty,note}])=>{
          setQty(id, qty); const nEl=$(`note-${id}`); if(nEl && note) nEl.value=note;
        });
      }catch{}
    }

    /* ========= è¨ˆç®— ========= */
    function calcTotal(){
      let total=0;
      Object.keys(state.menu).forEach(id=>{
        const q=getQty(id); if(q>0) total += (Number(state.menu[id].price)||0) * q;
      });
      return total;
    }
    function updateTotal(){
      const total=calcTotal(); let count=0;
      Object.keys(state.menu).forEach(id=> count += getQty(id));
      $("total").textContent = `åˆè¨ˆé‡‘é¡ï¼š$${fmt.format(total)}${count?`ï¼ˆ${count} é …ï¼‰`:""}`;
      $("submitBtn").disabled = (count===0) || state.submitting;
    }

    /* ========= é€å‡º ========= */
   
  // é€å‡ºè¨‚å–®ï¼ˆæ•´æ®µè¦†è“‹åŸæœ¬çš„ï¼‰
  $("submitBtn").addEventListener("click", async ()=>{
    if (state.submitting) return;

    // è’é›†å“é …
    const items = [];
    Object.keys(state.menu).forEach(id=>{
      const q = getQty(id);
      if (q>0){
        const note = $(`note-${id}`)?.value?.trim() || "";
        items.push({
          id, name: state.menu[id].name,
          price: Number(state.menu[id].price)||0, quantity: q, note
        });
      }
    });
    if (!items.length){ showToast("è«‹å…ˆé¸æ“‡é¤é»"); return; }

    const order = {
      table: currentTable,
      sessionId: ACTIVE_SESSION_ID || null,
      time: new Date().toISOString(),
      items,
      total: items.reduce((s,it)=> s + (it.price*it.quantity), 0)
    };

    const btn = $("submitBtn");
    const oldText = btn.textContent;

    // é€²å…¥é€å‡ºä¸­
    state.submitting = true;
    btn.textContent = "é€å‡ºä¸­â€¦";
    btn.disabled = true;

    try{
      if (state.source === "firebase" && db){
        // å¯«å…¥ Firebase
        const ref = await db.ref("orders").push(order);

        // ===== æˆåŠŸå¾Œçš„ UIï¼šå…¨éƒ¨ç”¨ã€Œ?ã€é˜²å‘† =====
        localStorage.removeItem(STORAGE_KEY);
        $("orderId")?.textContent = ref.key || "(æœªçŸ¥ç·¨è™Ÿ)";
        $("success")?.style && ( $("success").style.display = "block" );
        $("menu")?.style && ( $("menu").style.display = "none" );
        $("checkoutBar")?.style && ( $("checkoutBar").style.display = "none" );
        $("msg")?.classList && $("msg").classList.add("ok");
        if ($("msg")) $("msg").textContent = "";

        showToast("è¨‚å–®å·²é€å‡º");
        // ä¹ŸæŠŠæŒ‰éˆ•é¡¯ç¤ºæˆå·²é€å‡ºï¼Œé¿å…æŸäº›è£ç½®æŠŠ bar ä¿ç•™åœ¨ç•«é¢åº•éƒ¨
        btn.textContent = "å·²é€å‡º";
      }else{
        // JSON/é›¢ç·šæ¨¡å¼
        console.log("ï¼ˆJSON æ¨¡å¼ï¼‰åƒ…å‰ç«¯è¨˜éŒ„ï¼š", order);
        $("msg")?.classList && $("msg").classList.add("ok");
        if ($("msg")) $("msg").textContent = "âœ… å·²è¨˜éŒ„æ‚¨çš„é¸æ“‡ï¼ˆç›®å‰ç‚ºé›¢ç·š/JSON æ¨¡å¼ï¼‰";
        showToast("å·²è¨˜éŒ„æ‚¨çš„é¸æ“‡");
        btn.textContent = oldText;  // é›¢ç·šå°±é‚„åŸæŒ‰éˆ•
        btn.disabled = false;
      }
    }catch(err){
      // ä»»ä½•éŒ¯èª¤éƒ½å›å¾©æŒ‰éˆ•ç‹€æ…‹
      console.error(err);
      $("msg")?.classList && $("msg").classList.add("err");
      if ($("msg")) $("msg").textContent = `âš ï¸ è¨‚å–®é€å‡ºå¤±æ•—ï¼š${err.message||err}`;
      showToast("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
      btn.textContent = oldText;
      btn.disabled = false;
    }finally{
      // æ”¶å°¾ï¼šçµæŸé€å‡ºç‹€æ…‹ã€æ›´æ–°é‡‘é¡
      state.submitting = false;
      updateTotal();
    }
  });
</script>


    /* ========= å•Ÿå‹• ========= */
    (async()=>{
      const ok = await checkSession();
      if(ok) loadMenu();
    })();
  </script>
</body>
</html>
