<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>點餐系統</title>

  <!-- Firebase（compat 版） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <style>
    /* === 基本樣式（保留你原本的 UI） === */
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;
           margin:0; background:#f7f7f7; }
    header { padding:16px; position:sticky; top:0; background:#f7f7f7; z-index:5; }
    h1 { margin:0; color:#333; font-size:1.4rem; }
    main { padding:0 16px 96px; }
    h2 { color:#333; margin:16px 0 8px; font-size:1.1rem; }

    .checkout-bar {
      position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e5e5e5;
      padding:10px 12px; display:flex; align-items:center; gap:12px; z-index:10;
    }
    .checkout-bar .sum { font-weight:900; font-size:1.1rem; }
    .checkout-bar .muted { color:#666; font-size:.9rem; }
    button.primary {
      margin-left:auto; padding:.75rem 1.2rem; font-size:1rem; font-weight:700;
      background:#0d6efd; color:#fff; border:0; border-radius:10px; cursor:pointer;
    }
    button.primary[disabled] { opacity:.6; cursor:not-allowed; }

    .message { padding:10px 16px; min-height:1.25rem; font-weight:700; }
    .ok { color:#0a7d39; } .err { color:#b3261e; } .info { color:#0b5ed7; }

    .toast {
      position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:10px;
      font-size:.95rem; opacity:0; pointer-events:none; transition:opacity .25s;
      z-index:100;
    }
    .toast.show { opacity:1; }

    .success { display:none; padding:24px; text-align:center; }
    .success h3 { margin:0 0 8px; }
    .success .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                     background:#f1f3f5; border:1px dashed #cbd5e1; border-radius:8px;
                     display:inline-block; padding:6px 10px; }

    /* === 圖片格狀菜單 === */
    .menu-toolbar{
      display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0 10px;
    }
    .menu-toolbar .pager{ display:flex; gap:6px; align-items:center; }
    .menu-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr); /* 手機：2 欄 */
      gap:12px;
    }
    @media (min-width: 640px){ .menu-grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 920px){ .menu-grid{ grid-template-columns: repeat(4, 1fr); } }

    .card2{
      background:#fff; border:1px solid #e5e5e5; border-radius:12px;
      overflow:hidden; display:flex; flex-direction:column;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .card2 .pic{
      aspect-ratio: 4/3;
      background:#f3f4f6;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .card2 .pic img{ width:100%; height:100%; object-fit:cover; }
    .card2 .body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
    .card2 .name{ font-weight:700; line-height:1.2; min-height:2.4em; }
    .card2 .price{ color:#334155; font-weight:800; }
    .card2 .ops{ display:flex; align-items:center; gap:8px; }
    .card2 .qtybox{
      display:flex; align-items:center; gap:6px; margin-left:auto;
    }
    .card2 .qtybox button{
      width:32px; height:32px; border-radius:8px; border:1px solid #d0d7de; background:#fff; cursor:pointer;
    }
    .card2 .qtybox input{
      width:48px; text-align:center; padding:6px; border:1px solid #d0d7de; border-radius:8px;
    }
    .card2 .note{
      width:100%; padding:7px 8px; border:1px dashed #cbd5e1; border-radius:10px; font-size:.9rem;
    }
    .btn-lite{ padding:6px 10px; border-radius:10px; border:1px solid #d0d7de; background:#fff; cursor:pointer; }
    .btn-lite[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <header><h1>📋 手機點餐</h1></header>

  <main>
    <div id="menu"></div>
    <div id="msg" class="message info"></div>

    <section id="success" class="success">
      <h3>✅ 訂單已送出</h3>
      <p>您的訂單編號：</p>
      <p class="code" id="orderId">—</p>
      <p style="margin-top:8px;">請保持頁面或出示此畫面給服務人員。</p>
      <!-- 回到點餐並保留當前 ?table= -->
      <button class="primary" onclick="location.href = location.pathname + location.search">回到點餐</button>
    </section>
  </main>

  <div class="checkout-bar" id="checkoutBar">
    <div class="sum" id="total">合計金額：$0</div>
    <div class="muted" id="tableInfo"></div>
    <button class="primary" id="submitBtn" disabled>送出訂單</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= 基本工具 =========
    const $ = (id) => document.getElementById(id);
    const fmt = new Intl.NumberFormat('zh-TW');
    function showToast(text, ms=1600) {
      const t = $("toast"); t.textContent = text; t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), ms);
    }

    // ========= 狀態 =========
    const qs = new URLSearchParams(location.search);
    const currentTable = qs.get("table") || "01";
    $("tableInfo").textContent = `桌號：${currentTable}`;
    const STORAGE_KEY = `cart_${currentTable}`;
    const state = { source: null, menu: {}, submitting: false };

    // 有效 session id（通過開桌檢查後取得）
    let ACTIVE_SESSION_ID = null;

    // ========= Firebase 設定 =========
    const firebaseConfig = {
      apiKey: "AIzaSyDaC14zf1ZxOsd-twyjzSgTIcNBwty1Is",
      authDomain: "zero-01-17457.firebaseapp.com",
      projectId: "zero-01-17457",
      storageBucket: "zero-01-17457.appspot.com",
      messagingSenderId: "534119998616",
      appId: "1:534119998616:web:ec3b6c2d48318f9c51ced",
      databaseURL: "https://zero-01-17457-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    let db = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); }
    catch(e){ console.warn("Firebase 初始化失敗，改用 JSON 備援：", e); }

    // ========= 菜單來源控制 =========
    const MENU_VER = "2025-08-11-01";                 // 每次改價換新版本
    const MENU_URL = `menu_items.json?v=${MENU_VER}`; // 避免快取
    const sourceOverride = qs.get("source");          // ?source=json 可強制用 JSON

    // ========= 開桌 session 檢查（重要） =========
    async function checkSession() {
      if (!db) return true; // JSON/本地測試放行
      try {
        const snap = await db.ref(`tables/${currentTable}/session`).once("value");
        const sess = snap.val();
        if (!sess || !sess.id || !sess.expiresAt || Number(sess.expiresAt) <= Date.now()) {
          $("msg").className = "message err";
          $("msg").textContent = "此桌尚未開桌或已結帳，請洽服務人員。";
          $("submitBtn").disabled = true;
          return false;
        }
        ACTIVE_SESSION_ID = String(sess.id);
        return true;
      } catch (e) {
        $("msg").className = "message err";
        $("msg").textContent = "讀取桌況失敗，請稍後重試或洽服務人員。";
        $("submitBtn").disabled = true;
        return false;
      }
    }

    // ========= 讀菜單（Firebase 優先，失敗/覆蓋則用 JSON）=========
    async function loadMenu() {
      $("msg").className = "message info";
      $("msg").textContent = "正在載入菜單…";

      if (db && sourceOverride !== "json") {
        try {
          const snap = await db.ref("menu_items").once("value");
          const data = snap.val();
          if (data && Object.keys(data).length) {
            state.source = "firebase";
            state.menu = data;
            renderMenu(data);
            restoreCart();
            updateTotal();
            $("msg").textContent = "";
            return;
          }
        } catch(err){ console.warn("讀取 Firebase 失敗：", err); }
      }

      try {
        const res = await fetch(MENU_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.source = "json";
        state.menu = data;
        renderMenu(data);
        restoreCart();
        updateTotal();
        $("msg").textContent = "（目前為離線/JSON 模式）";
      } catch(err){
        $("msg").className = "message err";
        $("msg").textContent = `⚠️ 無法取得菜單：${err.message}`;
      }
    }

    // ==== 圖片菜單輔助設定 ====
    const PAGE_SIZE = 8;              // 每頁幾個
    let currentCategory = null;       // 目前品類
    let currentPage = 1;              // 目前頁碼

    function getImageUrl(item){
      // 若 Firebase/menu_items 有 image 欄位就用；沒有就 fallback
      return item.image || "images/placeholder.jpg";
    }

    // 建立數量 +/-
    function qtyControlsHtml(id){
      return `
        <div class="qtybox" data-id="${id}">
          <button type="button" class="btn-dec">−</button>
          <input type="number" class="qty-input" id="qty-${id}" min="0" value="0" inputmode="numeric" />
          <button type="button" class="btn-inc">＋</button>
        </div>
      `;
    }

    // ========= 渲染菜單（圖片卡片 + 分頁）=========
    function renderMenu(raw){
      const menu = $("menu");
      menu.innerHTML = "";

      // 依分類分組
      const grouped = {};
      Object.entries(raw).forEach(([id, item])=>{
        (grouped[item.category || "其他"] ||= []).push({ ...item, id });
      });

      const categories = Object.keys(grouped);
      if (!categories.length){
        menu.innerHTML = `<div class="message err">沒有菜單資料</div>`;
        return;
      }
      if (!currentCategory) currentCategory = categories[0];

      // 工具列（分類 + 分頁）
      const toolbar = document.createElement("div");
      toolbar.className = "menu-toolbar";

      // 分類下拉
      const sel = document.createElement("select");
      sel.className = "btn-lite";
      categories.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        if (c === currentCategory) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = () => { currentCategory = sel.value; currentPage = 1; renderMenu(state.menu); };

      // 分頁計算
      const allItems = grouped[currentCategory] || [];
      const totalPages = Math.max(1, Math.ceil(allItems.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = allItems.slice(start, start + PAGE_SIZE);

      // 分頁控制
      const pager = document.createElement("div");
      pager.className = "pager";
      const btnPrev = document.createElement("button");
      btnPrev.className = "btn-lite";
      btnPrev.textContent = "上一頁";
      btnPrev.disabled = currentPage <= 1;
      btnPrev.onclick = () => { currentPage--; renderMenu(state.menu); };
      const pageInfo = document.createElement("span");
      pageInfo.textContent = `${currentPage} / ${totalPages}`;
      const btnNext = document.createElement("button");
      btnNext.className = "btn-lite";
      btnNext.textContent = "下一頁";
      btnNext.disabled = currentPage >= totalPages;
      btnNext.onclick = () => { currentPage++; renderMenu(state.menu); };

      pager.appendChild(btnPrev);
      pager.appendChild(pageInfo);
      pager.appendChild(btnNext);

      toolbar.appendChild(sel);
      toolbar.appendChild(pager);
      menu.appendChild(toolbar);

      // 卡片格狀
      const grid = document.createElement("div");
      grid.className = "menu-grid";

      pageItems.forEach(item=>{
        const card = document.createElement("div");
        card.className = "card2";
        card.innerHTML = `
          <div class="pic">
            <img src="${getImageUrl(item)}" alt="${item.name}" onerror="this.src='images/placeholder.jpg'">
          </div>
          <div class="body">
            <div class="name">${item.name}</div>
            <div class="ops">
              <div class="price">＄${fmt.format(Number(item.price)||0)}</div>
              ${qtyControlsHtml(item.id)}
            </div>
            ${item.enable_note ? `<input class="note" id="note-${item.id}" type="text" placeholder="備註（可留空）">` : ""}
          </div>
        `;
        grid.appendChild(card);
      });
      menu.appendChild(grid);

      // 綁定事件：＋/－、手動輸入、備註
      grid.querySelectorAll(".qtybox").forEach(box=>{
        const id = box.dataset.id;
        const input = box.querySelector(".qty-input");
        const btnInc = box.querySelector(".btn-inc");
        const btnDec = box.querySelector(".btn-dec");

        // 還原暫存
        const cachedAll = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        const cached = cachedAll[id];
        if (cached && typeof cached.qty === "number") input.value = cached.qty;
        const noteEl = $("note-"+id);
        if (noteEl && cached && typeof cached.note === "string") noteEl.value = cached.note;

        const onChange = ()=>{
          let v = parseInt(input.value||"0",10);
          if (isNaN(v) || v < 0) v = 0;
          if (v > 99) v = 99;
          input.value = v;
          updateTotal();
          saveCart();
        };
        btnInc.onclick = ()=>{ input.value = (parseInt(input.value||"0",10)||0) + 1; onChange(); };
        btnDec.onclick = ()=>{ input.value = Math.max(0, (parseInt(input.value||"0",10)||0) - 1); onChange(); };
        input.oninput = onChange;
      });

      grid.querySelectorAll(".note").forEach(n=>{
        n.onchange = saveCart;
      });

      updateTotal();
    }

    function clampQty(el){
      const v = parseInt(el.value || "0", 10);
      if (isNaN(v) || v < 0) el.value = 0;
      // 可視需求設上限：if (v > 99) el.value = 99;
    }

    // ========= 暫存（依桌號分開）=========
    function saveCart(){
      const data = {};
      Object.keys(state.menu).forEach(id=>{
        const qEl = $(`qty-${id}`);
        const nEl = $(`note-${id}`);
        if (!qEl) return;
        const qty = parseInt(qEl.value||"0",10)||0;
        const note = nEl ? (nEl.value||"") : "";
        if (qty>0 || note) data[id] = { qty, note };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function restoreCart(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const cart = JSON.parse(raw);
        Object.entries(cart).forEach(([id, {qty, note}])=>{
          const qEl = $(`qty-${id}`); if (qEl) qEl.value = qty;
          const nEl = $(`note-${id}`); if (nEl && note) nEl.value = note;
        });
      }catch{}
    }

    // ========= 統一的總價計算 =========
    function calcTotal(){
      let total = 0;
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        if (q>0) total += (Number(state.menu[id].price)||0) * q;
      });
      return total;
    }

    // ========= 計算總價 & 控制送出鈕 =========
    function updateTotal(){
      const total = calcTotal();
      let count = 0;
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        count += q;
      });
      $("total").textContent = `合計金額：$${fmt.format(total)}${count?`（${count} 項）`:""}`;
      $("submitBtn").disabled = (count === 0) || state.submitting;
    }

    // ========= 送出訂單 =========
    $("submitBtn").addEventListener("click", async ()=>{
      if (state.submitting) return;
      state.submitting = true; updateTotal();

      const items = [];
      Object.keys(state.menu).forEach(id=>{
        const q = parseInt(($(`qty-${id}`)?.value)||"0",10) || 0;
        if (q>0){
          const note = $(`note-${id}`)?.value?.trim() || "";
          items.push({
            id, name: state.menu[id].name,
            price: Number(state.menu[id].price)||0, quantity: q, note
          });
        }
      });

      if (items.length === 0){
        showToast("請先選擇餐點");
        state.submitting = false; updateTotal(); return;
      }

      const total = calcTotal();

      // 帶入 sessionId，供 Rules 驗證
      const order = {
        table: currentTable,
        sessionId: ACTIVE_SESSION_ID || null, // JSON 模式時可能為 null
        time: new Date().toISOString(),
        items,
        total
      };

      const btn = $("submitBtn");
      const oldText = btn.textContent;
      btn.textContent = "送出中…";
      btn.disabled = true;

      if (state.source === "firebase" && db){
        try{
          const ref = await db.ref("orders").push(order);
          localStorage.removeItem(STORAGE_KEY);
          $("msg").className = "message ok";
          $("msg").textContent = "";
          $("success").style.display = "block";
          $("orderId").textContent = ref.key || "(未知編號)";
          $("checkoutBar").style.display = "none";
          $("menu").style.display = "none";
          showToast("訂單已送出");
        }catch(err){
          $("msg").className = "message err";
          $("msg").textContent = `⚠️ 訂單送出失敗：${err.message}`;
          showToast("送出失敗，請重試");
          state.submitting = false; btn.textContent = oldText; updateTotal();
        }
      } else {
        console.log("（JSON 模式）僅前端記錄：", order);
        $("msg").className = "message ok";
        $("msg").textContent = "✅ 已記錄您的選擇（目前為離線/JSON 模式）";
        showToast("已記錄您的選擇");
        state.submitting = false; btn.textContent = oldText; updateTotal();
      }
    });

    // ========= 啟動：先檢查開桌，再載菜單 =========
    (async () => {
      const ok = await checkSession();   // 先做桌況驗證
      if (ok) loadMenu();
    })();
  </script>
</body>
</html>
